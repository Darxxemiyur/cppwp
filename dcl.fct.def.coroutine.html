<!DOCTYPE html><html lang='en'><head><title>[dcl.fct.def.coroutine]</title><meta charset='UTF-8'/><link rel='stylesheet' type='text/css' href='14882.css'/><link rel='stylesheet' type='text/css' href='expanded.css' title='Notes and examples expanded'/><link rel='alternate stylesheet' type='text/css' href='colored.css' title='Notes and examples colored'/><link rel='icon' href='icon.png'/></head><body><div class='wrapper'><h1 ><a class='secnum' style='min-width:73pt'>9</a> Declarations <a class='abbr_ref' href='./#dcl.dcl'>[dcl.dcl]</a></h1><h2 ><a class='secnum' style='min-width:88pt'>9.5</a> Function definitions <a class='abbr_ref' href='dcl.fct.def#coroutine'>[dcl.fct.def]</a></h2><h3 ><a class='secnum' style='min-width:103pt'>9.5.4</a> Coroutine definitions <a class='abbr_ref'>[dcl.fct.def.coroutine]</a></h3><span class='indexparent'><a class='index' id=':definition,coroutine'></a></span><div class='para' id='1'><div class='marginalizedparent'><a class='marginalized' href='#1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6205'>#</a></div><div id='1.sentence-1' class='sentence'>A function is a <a class='hidden_link' href='#def:coroutine' id='def:coroutine'><i >coroutine</i></a> if its <a class='grammarterm' href='dcl.fct.def.general#nt:function-body'>function-body</a> encloses a
<a class='grammarterm' href='stmt.return.coroutine#nt:coroutine-return-statement'>coroutine-return-statement</a>,
an <a class='grammarterm' href='expr.await#nt:await-expression'>await-expression</a>,
or a <a class='grammarterm' href='expr.yield#nt:yield-expression'>yield-expression</a><a class='hidden_link' href='#1.sentence-1'>.</a></div> <div id='1.sentence-2' class='sentence'>The <a class='grammarterm' href='dcl.fct#nt:parameter-declaration-clause'>parameter-declaration-clause</a> of the coroutine shall not
terminate with an ellipsis that is not part of
a <a class='grammarterm' href='dcl.fct#nt:parameter-declaration'>parameter-declaration</a><a class='hidden_link' href='#1.sentence-2'>.</a></div></div><div class='para' id='2'><div class='marginalizedparent'><a class='marginalized' href='#2'>2</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6214'>#</a></div><div id='2.example-1' class='example'>[&nbsp;<a class='example_link' href='#2.example-1'><span class='textit'>Example</span></a><div class='exampleBody'><span class='textit'>:</span> <pre class='codeblock'>
task<span class='anglebracket'>&lt;</span><span class='keyword'>int</span><span class='anglebracket'>&gt;</span> f<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;

task<span class='anglebracket'>&lt;</span><span class='keyword'>void</span><span class='anglebracket'>&gt;</span> g1<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  <span class='keyword'>int</span> i <span class='operator'>=</span> <span class='keyword'>co_await</span> f<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  std<span class='operator'>::</span>cout <span class='anglebracket'>&lt;</span><span class='anglebracket'>&lt;</span> <span class='literal'>"f() =&gt; "</span> <span class='anglebracket'>&lt;</span><span class='anglebracket'>&lt;</span> i <span class='anglebracket'>&lt;</span><span class='anglebracket'>&lt;</span> std<span class='operator'>::</span>endl;
<span class='curlybracket'>}</span>

<span class='keyword'>template</span> <span class='anglebracket'>&lt;</span><span class='keyword'>typename</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span> Args<span class='anglebracket'>&gt;</span>
task<span class='anglebracket'>&lt;</span><span class='keyword'>void</span><span class='anglebracket'>&gt;</span> g2<span class='parenthesis'>(</span>Args<span class='operator'>&amp;</span><span class='operator'>&amp;</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span>      <span class='comment'>// OK, ellipsis is a pack expansion</span>
  <span class='keyword'>int</span> i <span class='operator'>=</span> <span class='keyword'>co_await</span> f<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  std<span class='operator'>::</span>cout <span class='anglebracket'>&lt;</span><span class='anglebracket'>&lt;</span> <span class='literal'>"f() =&gt; "</span> <span class='anglebracket'>&lt;</span><span class='anglebracket'>&lt;</span> i <span class='anglebracket'>&lt;</span><span class='anglebracket'>&lt;</span> std<span class='operator'>::</span>endl;
<span class='curlybracket'>}</span>

task<span class='anglebracket'>&lt;</span><span class='keyword'>void</span><span class='anglebracket'>&gt;</span> g3<span class='parenthesis'>(</span><span class='keyword'>int</span> a, <span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span>     <span class='comment'>// error: variable parameter list not allowed</span>
  <span class='keyword'>int</span> i <span class='operator'>=</span> <span class='keyword'>co_await</span> f<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  std<span class='operator'>::</span>cout <span class='anglebracket'>&lt;</span><span class='anglebracket'>&lt;</span> <span class='literal'>"f() =&gt; "</span> <span class='anglebracket'>&lt;</span><span class='anglebracket'>&lt;</span> i <span class='anglebracket'>&lt;</span><span class='anglebracket'>&lt;</span> std<span class='operator'>::</span>endl;
<span class='curlybracket'>}</span>
</pre> —&nbsp;<i>end example</i></div>&nbsp;]</div> </div><div class='para' id='3'><div class='marginalizedparent'><a class='marginalized' href='#3'>3</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6237'>#</a></div><div id='3.sentence-1' class='sentence'>The <a class='hidden_link' href='#def:coroutine,promise_type' id='def:coroutine,promise_type'><i >promise type</i></a> of a coroutine is
<span class='texttt'>std<span class='operator'>&#x200b;::&#x200b;</span>coroutine_&shy;traits<span class='anglebracket'>&lt;</span>R, P<span class="mjx-chtml"><span class="mjx-math"><span class="mjx-mrow" aria-hidden="true"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-mi"><span class="mjx-char"></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.372em; padding-bottom: 0.372em;">1</span></span></span></span></span></span></span>, <span class='math'>&hellip;</span>, P<span class="mjx-chtml"><span class="mjx-math"><span class="mjx-mrow" aria-hidden="true"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-mi"><span class="mjx-char"></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.225em; padding-bottom: 0.298em;">n</span></span></span></span></span></span></span><span class='anglebracket'>&gt;</span><span class='operator'>&#x200b;::&#x200b;</span>promise_&shy;type</span>,
where
<span class='texttt'>R</span> is the return type of the function, and
<span class="mjx-chtml"><span class="mjx-math"><span class="mjx-mrow" aria-hidden="true"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-texatom"><span class="mjx-mrow"><span class="mjx-mtext"><span class="mjx-char MJXc-TeX-type-R" style="padding-top: 0.372em; padding-bottom: 0.225em;">P</span></span></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.372em; padding-bottom: 0.372em;">1</span></span></span></span><span class="mjx-mo MJXc-space1"><span class="mjx-char MJXc-TeX-main-R" style="margin-top: -0.144em; padding-bottom: 0.372em;">…</span></span><span class="mjx-texatom MJXc-space1"><span class="mjx-mrow"></span></span><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-texatom"><span class="mjx-mrow"><span class="mjx-mtext"><span class="mjx-char MJXc-TeX-type-R" style="padding-top: 0.372em; padding-bottom: 0.225em;">P</span></span></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.225em; padding-bottom: 0.298em;">n</span></span></span></span></span></span></span> are the sequence of types of the function parameters,
preceded by the type of the implicit object parameter (<a href='over.match.funcs'>[over.match.funcs]</a>)
if the coroutine is a non-static member function<a class='hidden_link' href='#3.sentence-1'>.</a></div> <div id='3.sentence-2' class='sentence'>The promise type shall be a class type<a class='hidden_link' href='#3.sentence-2'>.</a></div></div><div class='para' id='4'><div class='marginalizedparent'><a class='marginalized' href='#4'>4</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6248'>#</a></div><div id='4.sentence-1' class='sentence'>In the following, <span class="mjx-chtml"><span class="mjx-math"><span class="mjx-mrow" aria-hidden="true"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-texatom"><span class="mjx-mrow"><span class="mjx-mtext"><span class="mjx-char MJXc-TeX-type-R" style="padding-top: 0.225em; padding-bottom: 0.519em;">p</span></span></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.398em; padding-right: 0.071em;"><span class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.446em; padding-bottom: 0.298em;">i</span></span></span></span></span></span></span> is an lvalue of type <span class="mjx-chtml"><span class="mjx-math"><span class="mjx-mrow" aria-hidden="true"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-texatom"><span class="mjx-mrow"><span class="mjx-mtext"><span class="mjx-char MJXc-TeX-type-R" style="padding-top: 0.372em; padding-bottom: 0.225em;">P</span></span></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.446em; padding-bottom: 0.298em;">i</span></span></span></span></span></span></span>,
where
<span class="mjx-chtml"><span class="mjx-math"><span class="mjx-mrow" aria-hidden="true"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-texatom"><span class="mjx-mrow"><span class="mjx-mtext"><span class="mjx-char MJXc-TeX-type-R" style="padding-top: 0.225em; padding-bottom: 0.519em;">p</span></span></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.398em; padding-right: 0.071em;"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.372em; padding-bottom: 0.372em;">1</span></span></span></span></span></span></span> denotes <span class='texttt'><span class='operator'>*</span><span class='keyword'>this</span></span> and
<span class="mjx-chtml"><span class="mjx-math"><span class="mjx-mrow" aria-hidden="true"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-texatom"><span class="mjx-mrow"><span class="mjx-mtext"><span class="mjx-char MJXc-TeX-type-R" style="padding-top: 0.225em; padding-bottom: 0.519em;">p</span></span></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.398em; padding-right: 0.071em;"><span class="mjx-texatom"><span class="mjx-mrow"><span class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.446em; padding-bottom: 0.298em;">i</span></span><span class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.298em; padding-bottom: 0.446em;">+</span></span><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.372em; padding-bottom: 0.372em;">1</span></span></span></span></span></span></span></span></span> denotes the <span class="mjx-chtml"><span class="mjx-math"><span class="mjx-mrow" aria-hidden="true"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.446em; padding-bottom: 0.298em;">i</span></span></span><span class="mjx-sup" style="font-size: 70.7%; vertical-align: 0.513em; padding-left: 0px; padding-right: 0.071em;"><span class="mjx-texatom"><span class="mjx-mrow"><span class="mjx-mtext"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.372em; padding-bottom: 0.372em;">th</span></span></span></span></span></span></span></span></span> function parameter
for a non-static member function, and
<span class="mjx-chtml"><span class="mjx-math"><span class="mjx-mrow" aria-hidden="true"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-texatom"><span class="mjx-mrow"><span class="mjx-mtext"><span class="mjx-char MJXc-TeX-type-R" style="padding-top: 0.225em; padding-bottom: 0.519em;">p</span></span></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.398em; padding-right: 0.071em;"><span class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.446em; padding-bottom: 0.298em;">i</span></span></span></span></span></span></span> denotes
the <span class="mjx-chtml"><span class="mjx-math"><span class="mjx-mrow" aria-hidden="true"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.446em; padding-bottom: 0.298em;">i</span></span></span><span class="mjx-sup" style="font-size: 70.7%; vertical-align: 0.513em; padding-left: 0px; padding-right: 0.071em;"><span class="mjx-texatom"><span class="mjx-mrow"><span class="mjx-mtext"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.372em; padding-bottom: 0.372em;">th</span></span></span></span></span></span></span></span></span> function parameter otherwise<a class='hidden_link' href='#4.sentence-1'>.</a></div></div><div class='para' id='5'><div class='marginalizedparent'><a class='marginalized' href='#5'>5</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6257'>#</a></div><div id='5.sentence-1' class='sentence'>A coroutine behaves as if its <a class='grammarterm' href='dcl.fct.def.general#nt:function-body'>function-body</a> were replaced by:
<pre class='ncsimplebnf'><span class='terminal'><span class='curlybracket'>{</span></span>
&#9;<span class='textit'>promise-type</span> <span class='texttt'><span class='textit'>promise</span></span> <span class='textit'>promise-constructor-arguments</span> <span class='terminal'>;</span>
&#9;<span class='terminal'><span class='keyword'>try</span></span> <span class='terminal'><span class='curlybracket'>{</span></span>
&#9;&#9;<span class='terminal'><span class='keyword'>co_await</span></span> <span class='terminal'><span class='texttt'><span class='textit'>promise</span></span><span class='operator'>.</span>initial_suspend<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> <span class='terminal'>;</span>
&#9;&#9;<a class='grammarterm' href='dcl.fct.def.general#nt:function-body'>function-body</a>
&#9;<span class='terminal'><span class='curlybracket'>}</span> <span class='keyword'>catch</span> <span class='parenthesis'>(</span> <span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span> <span class='parenthesis'>)</span> <span class='curlybracket'>{</span></span>
&#9;&#9;<span class='terminal'><span class='keyword'>if</span> <span class='parenthesis'>(</span><span class='operator'>!</span><span class='texttt'><span class='textit'>initial-await-resume-called</span></span><span class='parenthesis'>)</span></span>
&#9;&#9;&#9;<span class='terminal'><span class='keyword'>throw</span></span> <span class='terminal'>;</span>
&#9;&#9;<span class='terminal'><span class='texttt'><span class='textit'>promise</span></span><span class='operator'>.</span>unhandled_exception<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> <span class='terminal'>;</span>
&#9;<span class='terminal'><span class='curlybracket'>}</span></span>
<span class='texttt'><span class='textit'>final-suspend</span></span> <span class='terminal'><span class='operator'>:</span></span>
&#9;<span class='terminal'><span class='keyword'>co_await</span></span> <span class='terminal'><span class='texttt'><span class='textit'>promise</span></span><span class='operator'>.</span>final_suspend<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> <span class='terminal'>;</span>
<span class='terminal'><span class='curlybracket'>}</span></span>
</pre>
where
<ul class='itemize'><li id='5.1'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#5.1'>(5.1)</a></div>the <a class='grammarterm' href='expr.await#nt:await-expression'>await-expression</a> containing
the call to <span class='texttt'>initial_&shy;suspend</span>
is the <a class='hidden_link' href='#def:initial_suspend_point' id='def:initial_suspend_point'><i >initial suspend point</i></a>, and</li><li id='5.2'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#5.2'>(5.2)</a></div>the <a class='grammarterm' href='expr.await#nt:await-expression'>await-expression</a> containing
the call to <span class='texttt'>final_&shy;suspend</span>
is the <a class='hidden_link' href='#def:final_suspend_point' id='def:final_suspend_point'><i >final suspend point</i></a>, and</li><li id='5.3'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#5.3'>(5.3)</a></div><span class='textit'>initial-await-resume-called</span>
is initially <span class='texttt'><span class='literal'>false</span></span> and is set to <span class='texttt'><span class='literal'>true</span></span>
immediately before the evaluation
of the <span class='textit'>await-resume</span> expression (<a href='expr.await'>[expr.await]</a>)
of the initial suspend point, and</li><li id='5.4'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#5.4'>(5.4)</a></div><span class='textit'>promise-type</span> denotes the promise type, and</li><li id='5.5'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#5.5'>(5.5)</a></div>the object denoted by the exposition-only name <span class='texttt'><span class='textit'>promise</span></span>
is the <a class='hidden_link' href='#def:promise_object' id='def:promise_object'><i >promise object</i></a> of the coroutine, and</li><li id='5.6'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#5.6'>(5.6)</a></div>the label denoted by the name <span class='texttt'><span class='textit'>final-suspend</span></span>
is defined for exposition only (<a href='stmt.return.coroutine'>[stmt.return.coroutine]</a>), and</li><li id='5.7'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#5.7'>(5.7)</a></div><span class='textit'>promise-constructor-arguments</span> is determined as follows:
overload resolution is performed on a promise constructor call created by
assembling an argument list with lvalues <span class="mjx-chtml"><span class="mjx-math"><span class="mjx-mrow" aria-hidden="true"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-texatom"><span class="mjx-mrow"><span class="mjx-mtext"><span class="mjx-char MJXc-TeX-type-R" style="padding-top: 0.225em; padding-bottom: 0.519em;">p</span></span></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.398em; padding-right: 0.071em;"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.372em; padding-bottom: 0.372em;">1</span></span></span></span><span class="mjx-mo MJXc-space1"><span class="mjx-char MJXc-TeX-main-R" style="margin-top: -0.144em; padding-bottom: 0.372em;">…</span></span><span class="mjx-texatom MJXc-space1"><span class="mjx-mrow"></span></span><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-texatom"><span class="mjx-mrow"><span class="mjx-mtext"><span class="mjx-char MJXc-TeX-type-R" style="padding-top: 0.225em; padding-bottom: 0.519em;">p</span></span></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.398em; padding-right: 0.071em;"><span class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.225em; padding-bottom: 0.298em;">n</span></span></span></span></span></span></span><a class='hidden_link' href='#5.sentence-1'>.</a> If a viable
constructor is found (<a href='over.match.viable'>[over.match.viable]</a>), then
<span class='textit'>promise-constructor-arguments</span> is
<span class='texttt'><span class='parenthesis'>(</span>p<span class="mjx-chtml"><span class="mjx-math"><span class="mjx-mrow" aria-hidden="true"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-mi"><span class="mjx-char"></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.372em; padding-bottom: 0.372em;">1</span></span></span></span></span></span></span>, <span class='math'>&hellip;</span>, p<span class="mjx-chtml"><span class="mjx-math"><span class="mjx-mrow" aria-hidden="true"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-mi"><span class="mjx-char"></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.225em; padding-bottom: 0.298em;">n</span></span></span></span></span></span></span><span class='parenthesis'>)</span></span>, otherwise
<span class='textit'>promise-constructor-arguments</span> is empty.</li></ul></div></div><div class='para' id='6'><div class='marginalizedparent'><a class='marginalized' href='#6'>6</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6310'>#</a></div><div id='6.sentence-1' class='sentence'>The <a class='grammarterm' href='expr.prim.id.unqual#nt:unqualified-id'>unqualified-id</a><span class='textit'>s</span> <span class='texttt'>return_&shy;void</span>
and <span class='texttt'>return_&shy;value</span> are looked up in the scope of the promise type<a class='hidden_link' href='#6.sentence-1'>.</a></div> <div id='6.sentence-2' class='sentence'>If both are found, the program is ill-formed<a class='hidden_link' href='#6.sentence-2'>.</a></div> <div id='6.note-1' class='note'>[&nbsp;<a class='note_link' href='#6.note-1'><span class='textit'>Note</span></a><div class='noteBody'><span class='textit'>:</span> <div id='6.sentence-3' class='sentence'>If the <a class='grammarterm' href='expr.prim.id.unqual#nt:unqualified-id'>unqualified-id</a> <span class='texttt'>return_&shy;void</span> is found, flowing off
the end of a coroutine is equivalent to a <span class='texttt'><span class='keyword'>co_&shy;return</span></span> with no operand<a class='hidden_link' href='#6.sentence-3'>.</a></div> <div id='6.sentence-4' class='sentence'>Otherwise, flowing off the end of a coroutine
results in undefined behavior (<a href='stmt.return.coroutine'>[stmt.return.coroutine]</a>)<a class='hidden_link' href='#6.sentence-4'>.</a></div> —&nbsp;<i>end note</i></div>&nbsp;]</div> </div><div class='para' id='7'><div class='marginalizedparent'><a class='marginalized' href='#7'>7</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6321'>#</a></div><div id='7.sentence-1' class='sentence'>The expression <span class='texttt'><span class='texttt'><span class='textit'>promise</span></span><span class='operator'>.</span>get_&shy;return_&shy;object<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> is used
to initialize
the glvalue result or prvalue result object of a call to a coroutine<a class='hidden_link' href='#7.sentence-1'>.</a></div> <div id='7.sentence-2' class='sentence'>The call to <span class='texttt'>get_&shy;return_&shy;object</span>
is sequenced before
the call to <span class='texttt'>initial_&shy;suspend</span>
and is invoked at most once<a class='hidden_link' href='#7.sentence-2'>.</a></div></div><div class='para' id='8'><div class='marginalizedparent'><a class='marginalized' href='#8'>8</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6330'>#</a></div><div id='8.sentence-1' class='sentence'>A suspended coroutine can be resumed to continue execution by invoking
a resumption member function (<a href='coroutine.handle.resumption'>[coroutine.handle.resumption]</a>)
of a coroutine handle (<a href='coroutine.handle'>[coroutine.handle]</a>)
that refers to the coroutine<a class='hidden_link' href='#8.sentence-1'>.</a></div> <div id='8.sentence-2' class='sentence'>The function that invoked a resumption member function is
called the <a class='hidden_link' href='#def:coroutine,resumer' id='def:coroutine,resumer'><i >resumer</i></a><a class='hidden_link' href='#8.sentence-2'>.</a></div> <div id='8.sentence-3' class='sentence'>Invoking a resumption member function for a coroutine
that is not suspended results in undefined behavior<a class='hidden_link' href='#8.sentence-3'>.</a></div></div><div class='para' id='9'><div class='marginalizedparent'><a class='marginalized' href='#9'>9</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6340'>#</a></div><div id='9.sentence-1' class='sentence'>An implementation may need to allocate additional storage for a coroutine<a class='hidden_link' href='#9.sentence-1'>.</a></div> <div id='9.sentence-2' class='sentence'>This storage is known as the <a class='hidden_link' href='#def:coroutine_state' id='def:coroutine_state'><i >coroutine state</i></a> and is obtained by calling
a non-array allocation function (<a href='basic.stc.dynamic.allocation'>[basic.stc.dynamic.allocation]</a>)<a class='hidden_link' href='#9.sentence-2'>.</a></div> <div id='9.sentence-3' class='sentence'>The allocation function's name is looked up in the scope of the promise type<a class='hidden_link' href='#9.sentence-3'>.</a></div> <div id='9.sentence-4' class='sentence'>If this lookup fails, the allocation function's name is looked up in the
global scope<a class='hidden_link' href='#9.sentence-4'>.</a></div> <div id='9.sentence-5' class='sentence'>If the lookup finds an allocation function in the scope of the promise type,
overload resolution is performed on a function call created by assembling an
argument list<a class='hidden_link' href='#9.sentence-5'>.</a></div> <div id='9.sentence-6' class='sentence'>The first argument is the amount of space requested, and has
type <span class='texttt'>std<span class='operator'>&#x200b;::&#x200b;</span>size_&shy;t</span><a class='hidden_link' href='#9.sentence-6'>.</a></div> <div id='9.sentence-7' class='sentence'>The lvalues <span class="mjx-chtml"><span class="mjx-math"><span class="mjx-mrow" aria-hidden="true"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-texatom"><span class="mjx-mrow"><span class="mjx-mtext"><span class="mjx-char MJXc-TeX-type-R" style="padding-top: 0.225em; padding-bottom: 0.519em;">p</span></span></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.398em; padding-right: 0.071em;"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.372em; padding-bottom: 0.372em;">1</span></span></span></span><span class="mjx-mo MJXc-space1"><span class="mjx-char MJXc-TeX-main-R" style="margin-top: -0.144em; padding-bottom: 0.372em;">…</span></span><span class="mjx-texatom MJXc-space1"><span class="mjx-mrow"></span></span><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-texatom"><span class="mjx-mrow"><span class="mjx-mtext"><span class="mjx-char MJXc-TeX-type-R" style="padding-top: 0.225em; padding-bottom: 0.519em;">p</span></span></span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.398em; padding-right: 0.071em;"><span class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.225em; padding-bottom: 0.298em;">n</span></span></span></span></span></span></span> are the succeeding arguments<a class='hidden_link' href='#9.sentence-7'>.</a></div> <div id='9.sentence-8' class='sentence'>If no viable function is found (<a href='over.match.viable'>[over.match.viable]</a>),
overload resolution is performed again
on a function call created by passing just
the amount of space required as an argument of type <span class='texttt'>std<span class='operator'>&#x200b;::&#x200b;</span>size_&shy;t</span><a class='hidden_link' href='#9.sentence-8'>.</a></div></div><div class='para' id='10'><div class='marginalizedparent'><a class='marginalized' href='#10'>10</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6357'>#</a></div><div id='10.sentence-1' class='sentence'>The <a class='grammarterm' href='expr.prim.id.unqual#nt:unqualified-id'>unqualified-id</a> <span class='texttt'>get_&shy;return_&shy;object_&shy;on_&shy;allocation_&shy;failure</span>
is looked up in the scope of the promise type by class member access
lookup (<a href='basic.lookup.classref'>[basic.lookup.classref]</a>)<a class='hidden_link' href='#10.sentence-1'>.</a></div> <div id='10.sentence-2' class='sentence'>If any declarations are found, then the result
of a call to an allocation function used to obtain storage for the coroutine
state is assumed to return <span class='texttt'><span class='literal'>nullptr</span></span> if it fails to obtain storage,
and if a global allocation function is selected,
the <span class='texttt'><span class='operator'>&#x200b;::&#x200b;</span><span class='keyword'>operator</span> <span class='keyword'>new</span><span class='parenthesis'>(</span>size_&shy;t, nothrow_&shy;t<span class='parenthesis'>)</span></span> form is used<a class='hidden_link' href='#10.sentence-2'>.</a></div> <div id='10.sentence-3' class='sentence'>The allocation function used in this case shall have a non-throwing
<span class='grammarterm'>noexcept-specification</span><a class='hidden_link' href='#10.sentence-3'>.</a></div> <div id='10.sentence-4' class='sentence'>If the allocation function returns <span class='texttt'><span class='literal'>nullptr</span></span>, the coroutine returns
control to the caller of the coroutine and the return value is obtained by a
call to <span class='texttt'>T<span class='operator'>&#x200b;::&#x200b;</span>get_&shy;return_&shy;object_&shy;on_&shy;allocation_&shy;failure<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>, where <span class='texttt'>T</span>
is the promise type<a class='hidden_link' href='#10.sentence-4'>.</a></div><div style='height:0.6em;display:block'></div><div id='10.example-1' class='example'>[&nbsp;<a class='example_link' href='#10.example-1'><span class='textit'>Example</span></a><div class='exampleBody'><span class='textit'>:</span> <pre class='codeblock'>
<span class='preprocessordirective'>#include</span> <span class='anglebracket'>&lt;</span>iostream<span class='anglebracket'>&gt;</span>
<span class='preprocessordirective'>#include</span> <span class='anglebracket'>&lt;</span>coroutine<span class='anglebracket'>&gt;</span>

<span class='comment'>// <span class='tcode_in_codeblock'>&#x200b;::&#x200b;operator new(size_&shy;t, nothrow_&shy;t)</span> will be used if allocation is needed</span>
<span class='keyword'>struct</span> generator <span class='curlybracket'>{</span>
  <span class='keyword'>struct</span> promise_type;
  <span class='keyword'>using</span> handle <span class='operator'>=</span> std<span class='operator'>::</span>coroutine_handle<span class='anglebracket'>&lt;</span>promise_type<span class='anglebracket'>&gt;</span>;
  <span class='keyword'>struct</span> promise_type <span class='curlybracket'>{</span>
    <span class='keyword'>int</span> current_value;
    <span class='keyword'>static</span> <span class='keyword'>auto</span> get_return_object_on_allocation_failure<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span> <span class='keyword'>return</span> generator<span class='curlybracket'>{</span><span class='literal'>nullptr</span><span class='curlybracket'>}</span>; <span class='curlybracket'>}</span>
    <span class='keyword'>auto</span> get_return_object<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span> <span class='keyword'>return</span> generator<span class='curlybracket'>{</span>handle<span class='operator'>::</span>from_promise<span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span><span class='curlybracket'>}</span>; <span class='curlybracket'>}</span>
    <span class='keyword'>auto</span> initial_suspend<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span> <span class='keyword'>return</span> std<span class='operator'>::</span>suspend_always<span class='curlybracket'>{</span><span class='curlybracket'>}</span>; <span class='curlybracket'>}</span>
    <span class='keyword'>auto</span> final_suspend<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span> <span class='keyword'>return</span> std<span class='operator'>::</span>suspend_always<span class='curlybracket'>{</span><span class='curlybracket'>}</span>; <span class='curlybracket'>}</span>
    <span class='keyword'>void</span> unhandled_exception<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span> std<span class='operator'>::</span>terminate<span class='parenthesis'>(</span><span class='parenthesis'>)</span>; <span class='curlybracket'>}</span>
    <span class='keyword'>void</span> return_void<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span><span class='curlybracket'>}</span>
    <span class='keyword'>auto</span> yield_value<span class='parenthesis'>(</span><span class='keyword'>int</span> value<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
      current_value <span class='operator'>=</span> value;
      <span class='keyword'>return</span> std<span class='operator'>::</span>suspend_always<span class='curlybracket'>{</span><span class='curlybracket'>}</span>;
    <span class='curlybracket'>}</span>
  <span class='curlybracket'>}</span>;
  <span class='keyword'>bool</span> move_next<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span> <span class='keyword'>return</span> coro <span class='operator'>?</span> <span class='parenthesis'>(</span>coro<span class='operator'>.</span>resume<span class='parenthesis'>(</span><span class='parenthesis'>)</span>, <span class='operator'>!</span>coro<span class='operator'>.</span>done<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span> <span class='operator'>:</span> <span class='literal'>false</span>; <span class='curlybracket'>}</span>
  <span class='keyword'>int</span> current_value<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span> <span class='keyword'>return</span> coro<span class='operator'>.</span>promise<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='operator'>.</span>current_value; <span class='curlybracket'>}</span>
  generator<span class='parenthesis'>(</span>generator <span class='keyword'>const</span><span class='operator'>&amp;</span><span class='parenthesis'>)</span> <span class='operator'>=</span> <span class='keyword'>delete</span>;
  generator<span class='parenthesis'>(</span>generator <span class='operator'>&amp;</span><span class='operator'>&amp;</span> rhs<span class='parenthesis'>)</span> <span class='operator'>:</span> coro<span class='parenthesis'>(</span>rhs<span class='operator'>.</span>coro<span class='parenthesis'>)</span> <span class='curlybracket'>{</span> rhs<span class='operator'>.</span>coro <span class='operator'>=</span> <span class='literal'>nullptr</span>; <span class='curlybracket'>}</span>
  <span class='operator'>~</span>generator<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span> <span class='keyword'>if</span> <span class='parenthesis'>(</span>coro<span class='parenthesis'>)</span> coro<span class='operator'>.</span>destroy<span class='parenthesis'>(</span><span class='parenthesis'>)</span>; <span class='curlybracket'>}</span>
<span class='keyword'>private</span><span class='operator'>:</span>
  generator<span class='parenthesis'>(</span>handle h<span class='parenthesis'>)</span> <span class='operator'>:</span> coro<span class='parenthesis'>(</span>h<span class='parenthesis'>)</span> <span class='curlybracket'>{</span><span class='curlybracket'>}</span>
  handle coro;
<span class='curlybracket'>}</span>;
generator f<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span> <span class='keyword'>co_yield</span> <span class='literal'>1</span>; <span class='keyword'>co_yield</span> <span class='literal'>2</span>; <span class='curlybracket'>}</span>
<span class='keyword'>int</span> main<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  <span class='keyword'>auto</span> g <span class='operator'>=</span> f<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  <span class='keyword'>while</span> <span class='parenthesis'>(</span>g<span class='operator'>.</span>move_next<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span> std<span class='operator'>::</span>cout <span class='anglebracket'>&lt;</span><span class='anglebracket'>&lt;</span> g<span class='operator'>.</span>current_value<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='anglebracket'>&lt;</span><span class='anglebracket'>&lt;</span> std<span class='operator'>::</span>endl;
<span class='curlybracket'>}</span>
</pre> —&nbsp;<i>end example</i></div>&nbsp;]</div> </div><div class='para' id='11'><div class='marginalizedparent'><a class='marginalized' href='#11'>11</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6412'>#</a></div><div id='11.sentence-1' class='sentence'>The coroutine state is destroyed when control flows off the end of the
coroutine or the <span class='texttt'>destroy</span> member
function (<a href='coroutine.handle.resumption'>[coroutine.handle.resumption]</a>)
of a coroutine handle (<a href='coroutine.handle'>[coroutine.handle]</a>)
that refers to the coroutine
is invoked<a class='hidden_link' href='#11.sentence-1'>.</a></div> <div id='11.sentence-2' class='sentence'>In the latter case objects with automatic storage duration that
are in scope at the suspend point are destroyed in the reverse order of the
construction<a class='hidden_link' href='#11.sentence-2'>.</a></div> <div id='11.sentence-3' class='sentence'>The storage for the coroutine state is released by calling a
non-array deallocation function (<a href='basic.stc.dynamic.deallocation'>[basic.stc.dynamic.deallocation]</a>)<a class='hidden_link' href='#11.sentence-3'>.</a></div> <div id='11.sentence-4' class='sentence'>If <span class='texttt'>destroy</span> is called for a coroutine that is not suspended, the
program has undefined behavior<a class='hidden_link' href='#11.sentence-4'>.</a></div></div><div class='para' id='12'><div class='marginalizedparent'><a class='marginalized' href='#12'>12</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6426'>#</a></div><div id='12.sentence-1' class='sentence'>The deallocation function's name is looked up in the scope of the promise type<a class='hidden_link' href='#12.sentence-1'>.</a></div> <div id='12.sentence-2' class='sentence'>If this lookup fails, the deallocation function's name is looked up in the
global scope<a class='hidden_link' href='#12.sentence-2'>.</a></div> <div id='12.sentence-3' class='sentence'>If deallocation function lookup finds both a usual deallocation
function with only a pointer parameter and a usual deallocation function with
both a pointer parameter and a size parameter, then the selected deallocation
function shall be the one with two parameters<a class='hidden_link' href='#12.sentence-3'>.</a></div> <div id='12.sentence-4' class='sentence'>Otherwise, the selected
deallocation function shall be the function with one parameter<a class='hidden_link' href='#12.sentence-4'>.</a></div> <div id='12.sentence-5' class='sentence'>If no usual
deallocation function is found, the program is ill-formed<a class='hidden_link' href='#12.sentence-5'>.</a></div> <div id='12.sentence-6' class='sentence'>The selected deallocation function shall be called with the address of the
block of storage to be reclaimed as its first argument<a class='hidden_link' href='#12.sentence-6'>.</a></div> <div id='12.sentence-7' class='sentence'>If a deallocation
function with a parameter of type <span class='texttt'>std<span class='operator'>&#x200b;::&#x200b;</span>size_&shy;t</span> is used, the size of
the block is passed as the corresponding argument<a class='hidden_link' href='#12.sentence-7'>.</a></div></div><div class='para' id='13'><div class='marginalizedparent'><a class='marginalized' href='#13'>13</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6440'>#</a></div><div id='13.sentence-1' class='sentence'>When a coroutine is invoked,
after initializing its parameters (<a href='expr.call'>[expr.call]</a>),
a copy is created for each coroutine parameter<a class='hidden_link' href='#13.sentence-1'>.</a></div> <div id='13.sentence-2' class='sentence'>For a parameter of type <span class='mathit'>cv</span> <span class='texttt'>T</span>,
the copy is a variable of type <span class='mathit'>cv</span> <span class='texttt'>T</span>
with automatic storage duration that is direct-initialized
from an xvalue of type <span class='texttt'>T</span> referring to the parameter<a class='hidden_link' href='#13.sentence-2'>.</a></div> <div id='13.note-1' class='note'>[&nbsp;<a class='note_link' href='#13.note-1'><span class='textit'>Note</span></a><div class='noteBody'><span class='textit'>:</span> <div id='13.sentence-3' class='sentence'>An original parameter object is never
a const or volatile object (<a href='basic.type.qualifier'>[basic.type.qualifier]</a>)<a class='hidden_link' href='#13.sentence-3'>.</a></div> —&nbsp;<i>end note</i></div>&nbsp;]</div>  <div id='13.sentence-4' class='sentence'>
The initialization and destruction of each parameter copy occurs in the
context of the called coroutine<a class='hidden_link' href='#13.sentence-4'>.</a></div> <div id='13.sentence-5' class='sentence'>Initializations of parameter copies are sequenced before the call to the
coroutine promise constructor and indeterminately sequenced with respect to
each other<a class='hidden_link' href='#13.sentence-5'>.</a></div> <div id='13.sentence-6' class='sentence'>The lifetime of parameter copies ends immediately after the lifetime of the
coroutine promise object ends<a class='hidden_link' href='#13.sentence-6'>.</a></div> <div id='13.note-2' class='note'>[&nbsp;<a class='note_link' href='#13.note-2'><span class='textit'>Note</span></a><div class='noteBody'><span class='textit'>:</span> <div id='13.sentence-7' class='sentence'>If a coroutine has a parameter passed by reference, resuming the coroutine
after the lifetime of the entity referred to by that parameter has ended is
likely to result in undefined behavior<a class='hidden_link' href='#13.sentence-7'>.</a></div> —&nbsp;<i>end note</i></div>&nbsp;]</div> </div><div class='para' id='14'><div class='marginalizedparent'><a class='marginalized' href='#14'>14</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6465'>#</a></div><div id='14.sentence-1' class='sentence'>If the evaluation of the expression
<span class='texttt'><span class='texttt'><span class='textit'>promise</span></span><span class='operator'>.</span>unhandled_&shy;exception<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> exits via an exception,
the coroutine is considered suspended at the final suspend point<a class='hidden_link' href='#14.sentence-1'>.</a></div></div><div class='para' id='15'><div class='marginalizedparent'><a class='marginalized' href='#15'>15</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/3a3350ee86fb2dbc86752af66d56102d237d8c4f/source/declarations.tex#L6470'>#</a></div><div id='15.sentence-1' class='sentence'>The expression <span class='texttt'><span class='keyword'>co_&shy;await</span></span> <span class='texttt'><span class='texttt'><span class='textit'>promise</span></span><span class='operator'>.</span>final_&shy;suspend<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>
shall not be potentially-throwing (<a href='except.spec'>[except.spec]</a>)<a class='hidden_link' href='#15.sentence-1'>.</a></div></div></div></body></html>