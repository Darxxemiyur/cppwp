<!DOCTYPE html><html lang='en'><head><title>[expr.await]</title><meta charset='UTF-8'/><link rel='stylesheet' type='text/css' href='14882.css'/><link rel='stylesheet' type='text/css' href='expanded.css' title='Notes and examples expanded'/><link rel='alternate stylesheet' type='text/css' href='colored.css' title='Notes and examples colored'/><link rel='icon' href='icon.png'/></head><body><div class='wrapper'><h1 ><a class='secnum' style='min-width:73pt'>7</a> Expressions <a class='abbr_ref' href='./#expr'>[expr]</a></h1><h2 ><a class='secnum' style='min-width:88pt'>7.6</a> Compound expressions <a class='abbr_ref' href='expr.compound#expr.await'>[expr.compound]</a></h2><h3 ><a class='secnum' style='min-width:103pt'>7.6.2</a> Unary expressions <a class='abbr_ref' href='expr.unary#expr.await'>[expr.unary]</a></h3><h4 ><a class='secnum' style='min-width:118pt'>7.6.2.3</a> Await <a class='abbr_ref'>[expr.await]</a></h4><span class='indexparent'><a class='index' id=':expression,await'></a></span><span class='indexparent'><a class='index' id=':co_await'></a></span><div class='para' id='1'><div class='marginalizedparent'><a class='marginalized' href='#1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/0869f240e1b791a7c040d64ea44c435bfb67a237/source/expressions.tex#L4337'>#</a></div><div id='1.sentence-1' class='sentence'>The <span class='texttt'><span class='keyword'>co_&shy;await</span></span> expression is used to suspend evaluation of a
coroutine (<a href='dcl.fct.def.coroutine'>[dcl.fct.def.coroutine]</a>) while awaiting completion of
the computation represented by the operand expression<a class='hidden_link' href='#1.sentence-1'>.</a></div><pre class='bnf'><a class='nontermdef' href='#nt:await-expression' id='nt:await-expression'>await-expression</a><span class='ntdefcolon'>:</span>
&#9;<span class='terminal'><span class='keyword'>co_await</span></span> <a class='grammarterm' href='expr.cast#nt:cast-expression'>cast-expression</a>
</pre></div><div class='para' id='2'><div class='marginalizedparent'><a class='marginalized' href='#2'>2</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/0869f240e1b791a7c040d64ea44c435bfb67a237/source/expressions.tex#L4347'>#</a></div><div id='2.sentence-1' class='sentence'>An <a class='grammarterm' href='#nt:await-expression'>await-expression</a> shall appear only in a potentially-evaluated
expression within the <a class='grammarterm' href='stmt.block#nt:compound-statement'>compound-statement</a> of a
<a class='grammarterm' href='dcl.fct.def.general#nt:function-body'>function-body</a> outside of a <a class='grammarterm' href='except.pre#nt:handler'>handler</a><a class='hidden_link' href='#2.sentence-1'>.</a></div> <div id='2.sentence-2' class='sentence'>In a <a class='grammarterm' href='stmt.dcl#nt:declaration-statement'>declaration-statement</a> or in the
<a class='grammarterm' href='dcl.pre#nt:simple-declaration'>simple-declaration</a> (if any)
of a <span class='grammarterm'>for-init-statement</span>, an <a class='grammarterm' href='#nt:await-expression'>await-expression</a>
shall appear only in an <a class='grammarterm' href='dcl.init#nt:initializer'>initializer</a> of that
<a class='grammarterm' href='stmt.dcl#nt:declaration-statement'>declaration-statement</a> or <a class='grammarterm' href='dcl.pre#nt:simple-declaration'>simple-declaration</a><a class='hidden_link' href='#2.sentence-2'>.</a></div> <div id='2.sentence-3' class='sentence'>An <a class='grammarterm' href='#nt:await-expression'>await-expression</a> shall not appear in a
default argument (<a href='dcl.fct.default'>[dcl.fct.default]</a>)<a class='hidden_link' href='#2.sentence-3'>.</a></div> <div id='2.sentence-4' class='sentence'>An <a class='grammarterm' href='#nt:await-expression'>await-expression</a> shall not appear in the initializer of
a block-scope variable with static or thread storage duration<a class='hidden_link' href='#2.sentence-4'>.</a></div> <div id='2.sentence-5' class='sentence'>A context within a function where an <a class='grammarterm' href='#nt:await-expression'>await-expression</a> can appear
is called a <a class='hidden_link' href='#def:suspension_context' id='def:suspension_context'><i>suspension context</i></a> of the function<a class='hidden_link' href='#2.sentence-5'>.</a></div></div><div class='para' id='3'><div class='marginalizedparent'><a class='marginalized' href='#3'>3</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/0869f240e1b791a7c040d64ea44c435bfb67a237/source/expressions.tex#L4363'>#</a></div><div id='3.sentence-1' class='sentence'>Evaluation of an <a class='grammarterm' href='#nt:await-expression'>await-expression</a> involves the following
auxiliary types, expressions, and objects:</div><ul class='itemize'><li id='3.1'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#3.1'>(3.1)</a></div><div id='3.1.sentence-1' class='sentence'><span class='textit'>p</span> is an lvalue naming the promise
object (<a href='dcl.fct.def.coroutine'>[dcl.fct.def.coroutine]</a>)
of the enclosing coroutine and <span class='texttt'>P</span> is the type of that object<a class='hidden_link' href='#3.1.sentence-1'>.</a></div></li><li id='3.2'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#3.2'>(3.2)</a></div><div id='3.2.sentence-1' class='sentence'><span class='textit'>a</span> is the <a class='grammarterm' href='expr.cast#nt:cast-expression'>cast-expression</a> if
the <a class='grammarterm' href='#nt:await-expression'>await-expression</a> was implicitly produced by a
<a class='grammarterm' href='expr.yield#nt:yield-expression'>yield-expression</a>, an initial suspend point,
or a final suspend point (<a href='dcl.fct.def.coroutine'>[dcl.fct.def.coroutine]</a>)<a class='hidden_link' href='#3.2.sentence-1'>.</a></div> <div id='3.2.sentence-2' class='sentence'>Otherwise, the <a class='grammarterm' href='expr.prim.id.unqual#nt:unqualified-id'>unqualified-id</a> <span class='texttt'>await_&shy;transform</span> is
looked up within the scope of <span class='texttt'>P</span> by class member access
lookup (<a href='basic.lookup.classref'>[basic.lookup.classref]</a>),
and if this lookup finds at least one declaration, then <span class='textit'>a</span> is
<span class='mbox'><span class='textit'>p</span><span class='texttt'><span class='operator'>.</span>await_&shy;transform<span class='parenthesis'>(</span></span><a class='grammarterm' href='expr.cast#nt:cast-expression'>cast-expression</a><span class='texttt'><span class='parenthesis'>)</span></span></span>;
otherwise, <span class='textit'>a</span> is the  <a class='grammarterm' href='expr.cast#nt:cast-expression'>cast-expression</a><a class='hidden_link' href='#3.2.sentence-2'>.</a></div></li><li id='3.3'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#3.3'>(3.3)</a></div><div id='3.3.sentence-1' class='sentence'><span class='textit'>o</span> is determined by enumerating the applicable
<span class='texttt'><span class='keyword'>operator</span> <span class='keyword'>co_&shy;await</span></span> functions for an argument
<span class='textit'>a</span> (<a href='over.match.oper'>[over.match.oper]</a>), and choosing the best one through
overload resolution (<a href='over.match'>[over.match]</a>)<a class='hidden_link' href='#3.3.sentence-1'>.</a></div> <div id='3.3.sentence-2' class='sentence'>If overload resolution is ambiguous,
the program is ill-formed<a class='hidden_link' href='#3.3.sentence-2'>.</a></div> <div id='3.3.sentence-3' class='sentence'>If no viable functions are found, <span class='textit'>o</span> is <span class='textit'>a</span><a class='hidden_link' href='#3.3.sentence-3'>.</a></div> <div id='3.3.sentence-4' class='sentence'>Otherwise, <span class='textit'>o</span> is a call to the selected function
with the argument <span class='textit'>a</span><a class='hidden_link' href='#3.3.sentence-4'>.</a></div> <div id='3.3.sentence-5' class='sentence'>If <span class='textit'>o</span> would be a prvalue,
the temporary materialization conversion (<a href='conv.rval'>[conv.rval]</a>) is applied<a class='hidden_link' href='#3.3.sentence-5'>.</a></div></li><li id='3.4'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#3.4'>(3.4)</a></div><div id='3.4.sentence-1' class='sentence'><span class='textit'>e</span> is an lvalue
referring to the result of evaluating
the (possibly-converted) <span class='textit'>o</span><a class='hidden_link' href='#3.4.sentence-1'>.</a></div></li><li id='3.5'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#3.5'>(3.5)</a></div><div id='3.5.sentence-1' class='sentence'><span class='textit'>h</span> is an object of type
<span class='texttt'>std<span class='operator'>&#x200b;::&#x200b;</span>coroutine_&shy;handle<span class='anglebracket'>&lt;</span>P<span class='anglebracket'>&gt;</span></span>
referring to the enclosing coroutine<a class='hidden_link' href='#3.5.sentence-1'>.</a></div></li><li id='3.6'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#3.6'>(3.6)</a></div><div id='3.6.sentence-1' class='sentence'><span class='textit'>await-ready</span> is the expression
<span class='textit'>e</span><span class='texttt'><span class='operator'>.</span>await_&shy;ready<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>,
contextually converted to <span class='texttt'><span class='keyword'>bool</span></span><a class='hidden_link' href='#3.6.sentence-1'>.</a></div></li><li id='3.7'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#3.7'>(3.7)</a></div><div id='3.7.sentence-1' class='sentence'><span class='textit'>await-suspend</span> is the expression
<span class='textit'>e</span><span class='texttt'><span class='operator'>.</span>await_&shy;suspend<span class='parenthesis'>(</span></span><span class='textit'>h</span><span class='texttt'><span class='parenthesis'>)</span></span>,
which shall be a prvalue of type <span class='texttt'><span class='keyword'>void</span></span>, <span class='texttt'><span class='keyword'>bool</span></span>, or
<span class='texttt'>std<span class='operator'>&#x200b;::&#x200b;</span>coroutine_&shy;handle<span class='anglebracket'>&lt;</span>Z<span class='anglebracket'>&gt;</span></span> for some type <span class='texttt'>Z</span><a class='hidden_link' href='#3.7.sentence-1'>.</a></div></li><li id='3.8'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#3.8'>(3.8)</a></div><div id='3.8.sentence-1' class='sentence'><span class='textit'>await-resume</span> is the expression
<span class='textit'>e</span><span class='texttt'><span class='operator'>.</span>await_&shy;resume<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#3.8.sentence-1'>.</a></div></li></ul></div><div class='para' id='4'><div class='marginalizedparent'><a class='marginalized' href='#4'>4</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/0869f240e1b791a7c040d64ea44c435bfb67a237/source/expressions.tex#L4426'>#</a></div><div id='4.sentence-1' class='sentence'>The <a class='grammarterm' href='#nt:await-expression'>await-expression</a> has the same type and value category
as the <span class='textit'>await-resume</span> expression<a class='hidden_link' href='#4.sentence-1'>.</a></div></div><div class='para' id='5'><div class='marginalizedparent'><a class='marginalized' href='#5'>5</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/0869f240e1b791a7c040d64ea44c435bfb67a237/source/expressions.tex#L4430'>#</a></div><div id='5.sentence-1' class='sentence'>The <a class='grammarterm' href='#nt:await-expression'>await-expression</a> evaluates
the (possibly-converted) <span class='textit'>o</span> expression and
the <span class='textit'>await-ready</span> expression, then:
<ul class='itemize'><li id='5.1'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#5.1'>(5.1)</a></div>If the result of <span class='textit'>await-ready</span> is <span class='texttt'><span class='literal'>false</span></span>,
the coroutine is considered suspended. Then:
<ul class='itemize'><li id='5.1.1'><div class='marginalizedparent' style='left:-9em'><a class='marginalized' href='#5.1.1'>(5.1.1)</a></div>If the type of <span class='textit'>await-suspend</span>
is <span class='texttt'>std<span class='operator'>&#x200b;::&#x200b;</span>coroutine_&shy;handle<span class='anglebracket'>&lt;</span>Z<span class='anglebracket'>&gt;</span></span>,
<span class='textit'>await-suspend</span><span class='texttt'><span class='operator'>.</span>resume<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> is evaluated. <div id='5.1.1.note-1' class='note'>[&nbsp;<a class='note_link' href='#5.1.1.note-1'><span class='textit'>Note</span></a><div class='noteBody'><span class='textit'>:</span> This resumes the coroutine referred to
by the result of <span class='textit'>await-suspend</span>. Any number of coroutines may be successively resumed in this fashion,
eventually returning control flow to the current coroutine caller or
resumer (<a href='dcl.fct.def.coroutine'>[dcl.fct.def.coroutine]</a>). —&nbsp;<i>end note</i></div>&nbsp;]</div> </li><li id='5.1.2'><div class='marginalizedparent' style='left:-9em'><a class='marginalized' href='#5.1.2'>(5.1.2)</a></div>Otherwise, if the type of <span class='textit'>await-suspend</span>
is <span class='texttt'><span class='keyword'>bool</span></span>,
<span class='textit'>await-suspend</span> is evaluated,
and the coroutine is resumed if the result is <span class='texttt'><span class='literal'>false</span></span>.</li><li id='5.1.3'><div class='marginalizedparent' style='left:-9em'><a class='marginalized' href='#5.1.3'>(5.1.3)</a></div>Otherwise, <span class='textit'>await-suspend</span> is evaluated.</li></ul> 
If the evaluation of <span class='textit'>await-suspend</span>
exits via an exception, the exception is caught,
the coroutine is resumed, and the exception is immediately
re-thrown (<a href='except.throw'>[except.throw]</a>). Otherwise, control flow returns
to the current coroutine caller or resumer (<a href='dcl.fct.def.coroutine'>[dcl.fct.def.coroutine]</a>)
without exiting any scopes (<a href='stmt.jump'>[stmt.jump]</a>).</li><li id='5.2'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#5.2'>(5.2)</a></div>If the result of <span class='textit'>await-ready</span> is <span class='texttt'><span class='literal'>true</span></span>,
or when the coroutine is resumed,
the <span class='textit'>await-resume</span> expression is evaluated, and
its result is the result of the <a class='grammarterm' href='#nt:await-expression'>await-expression</a>.</li></ul></div></div><div class='para' id='6'><div class='marginalizedparent'><a class='marginalized' href='#6'>6</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/0869f240e1b791a7c040d64ea44c435bfb67a237/source/expressions.tex#L4475'>#</a></div><div id='6.example-1' class='example'>[&nbsp;<a class='example_link' href='#6.example-1'><span class='textit'>Example</span></a><div class='exampleBody'><span class='textit'>:</span> <pre class='codeblock'>
<span class='keyword'>template</span> <span class='anglebracket'>&lt;</span><span class='keyword'>typename</span> T<span class='anglebracket'>&gt;</span>
<span class='keyword'>struct</span> my_future <span class='curlybracket'>{</span>
  <span class='comment'>/* ... */</span>
  <span class='keyword'>bool</span> await_ready<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  <span class='keyword'>void</span> await_suspend<span class='parenthesis'>(</span>std<span class='operator'>::</span>coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>)</span>;
  T await_resume<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
<span class='curlybracket'>}</span>;

<span class='keyword'>template</span> <span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Rep, <span class='keyword'>class</span> Period<span class='anglebracket'>&gt;</span>
<span class='keyword'>auto</span> <span class='keyword'>operator</span> <span class='keyword'>co_await</span><span class='parenthesis'>(</span>std<span class='operator'>::</span>chrono<span class='operator'>::</span>duration<span class='anglebracket'>&lt;</span>Rep, Period<span class='anglebracket'>&gt;</span> d<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  <span class='keyword'>struct</span> awaiter <span class='curlybracket'>{</span>
    std<span class='operator'>::</span>chrono<span class='operator'>::</span>system_clock<span class='operator'>::</span>duration duration;
    <span class='comment'>/* ... */</span>
    awaiter<span class='parenthesis'>(</span>std<span class='operator'>::</span>chrono<span class='operator'>::</span>system_clock<span class='operator'>::</span>duration d<span class='parenthesis'>)</span> <span class='operator'>:</span> duration<span class='parenthesis'>(</span>d<span class='parenthesis'>)</span> <span class='curlybracket'>{</span><span class='curlybracket'>}</span>
    <span class='keyword'>bool</span> await_ready<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>const</span> <span class='curlybracket'>{</span> <span class='keyword'>return</span> duration<span class='operator'>.</span>count<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='anglebracket'>&lt;</span><span class='operator'>=</span> <span class='literal'>0</span>; <span class='curlybracket'>}</span>
    <span class='keyword'>void</span> await_resume<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span><span class='curlybracket'>}</span>
    <span class='keyword'>void</span> await_suspend<span class='parenthesis'>(</span>std<span class='operator'>::</span>coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span> h<span class='parenthesis'>)</span> <span class='curlybracket'>{</span> <span class='comment'>/* ... */</span> <span class='curlybracket'>}</span>
  <span class='curlybracket'>}</span>;
  <span class='keyword'>return</span> awaiter<span class='curlybracket'>{</span>d<span class='curlybracket'>}</span>;
<span class='curlybracket'>}</span>

<span class='keyword'>using</span> <span class='keyword'>namespace</span> std<span class='operator'>::</span>chrono;

my_future<span class='anglebracket'>&lt;</span><span class='keyword'>int</span><span class='anglebracket'>&gt;</span> h<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;

my_future<span class='anglebracket'>&lt;</span><span class='keyword'>void</span><span class='anglebracket'>&gt;</span> g<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  std<span class='operator'>::</span>cout <span class='anglebracket'>&lt;</span><span class='anglebracket'>&lt;</span> <span class='literal'>"just about go to sleep...\n"</span>;
  <span class='keyword'>co_await</span> <span class='literal'>10ms</span>;
  std<span class='operator'>::</span>cout <span class='anglebracket'>&lt;</span><span class='anglebracket'>&lt;</span> <span class='literal'>"resumed\n"</span>;
  <span class='keyword'>co_await</span> h<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
<span class='curlybracket'>}</span>

<span class='keyword'>auto</span> f<span class='parenthesis'>(</span><span class='keyword'>int</span> x <span class='operator'>=</span> <span class='keyword'>co_await</span> h<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>;   <span class='comment'>// error: <span class='grammarterm'>await-expression</span> outside of function suspension context</span>
<span class='keyword'>int</span> a<span class='squarebracket'>[</span><span class='squarebracket'>]</span> <span class='operator'>=</span> <span class='curlybracket'>{</span> <span class='keyword'>co_await</span> h<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>}</span>;     <span class='comment'>// error: <span class='grammarterm'>await-expression</span> outside of function suspension context</span>
</pre> —&nbsp;<i>end example</i></div>&nbsp;]</div> </div></div></body></html>